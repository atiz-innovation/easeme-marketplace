# SYS001 - Payment Initiation & Webhook Handling

## ЁЯСд р╕Ър╕Чр╕Ър╕▓р╕Ч
- р╕гр╕░р╕Ър╕Ъ

## ЁЯОп р╣Ар╕Ыр╣Йр╕▓р╕лр╕бр╕▓р╕вр╕Вр╕нр╕Зр╣Ар╕Др╕к
- р╣Гр╕Щр╕Рр╕▓р╕Щр╕░: р╕гр╕░р╕Ър╕Ъ
- р╕Хр╣Йр╕нр╕Зр╕Бр╕▓р╕г: р╕кр╣Ир╕Зр╕Др╕│р╕Вр╕нр╕Кр╕│р╕гр╕░р╣Ар╕Зр╕┤р╕Щр╣Др╕Ыр╕вр╕▒р╕З Xendit р╕гр╕н webhook р╣Бр╕ер╕░р╕нр╕▒р╕Ыр╣Ар╕Фр╕Хр╕кр╕Цр╕▓р╕Щр╕░р╣Бр╕Ър╕Ъ idempotent
- р╣Ар╕Юр╕╖р╣Ир╕н: р╣Ар╕Юр╕╖р╣Ир╕нр╣Гр╕лр╣Йр╕кр╕Цр╕▓р╕Щр╕░р╕Бр╕▓р╕гр╕Кр╕│р╕гр╕░р╣Ар╕Зр╕┤р╕Щр╕Хр╕гр╕Зр╕Бр╕▒р╕Ър╕гр╕░р╕Ър╕Ъ

## тЪЩя╕П р╣Ар╕Зр╕╖р╣Ир╕нр╕Щр╣Др╕Вр╕Бр╣Ир╕нр╕Щр╣Ар╕гр╕┤р╣Ир╕б (Precondition)
- System р╕кр╕гр╣Йр╕▓р╕З payment request р╕Бр╕▒р╕Ъ metadata booking_id user_id

## ЁЯзн р╕Ьр╕ер╕ер╕▒р╕Юр╕Шр╣Мр╣Бр╕ер╕░р╕кр╕Цр╕▓р╕Щр╕Бр╕▓р╕гр╕Ур╣М
- тЬЕ р╕Ьр╕ер╕ер╕▒р╕Юр╕Шр╣Мр╕Чр╕╡р╣Ир╕Др╕▓р╕Фр╕лр╕зр╕▒р╕З (Success Flow): System р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ъ signature р╣Бр╕ер╕░ idempotency р╣Бр╕ер╕░р╕нр╕▒р╕Ыр╣Ар╕Фр╕Х payment р╣Бр╕ер╕░ booking status
- тЭМ р╕Ьр╕ер╕ер╕▒р╕Юр╕Шр╣Мр╕Чр╕╡р╣И Failure:
  - р╕ер╣Йр╕бр╣Ар╕лр╕ер╕з: р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ъ signature р╣Др╕бр╣Ир╕Ьр╣Ир╕▓р╕Щ р╕Чр╕│р╣Гр╕лр╣Йр╣Др╕бр╣Ир╕нр╕▒р╕Ыр╣Ар╕Фр╕Х payment_id р╣Бр╕ер╕░ booking_id
  - р╕ер╣Йр╕бр╣Ар╕лр╕ер╕з: р╣Ар╕Бр╕┤р╕Фр╕Вр╣Йр╕нр╕Ьр╕┤р╕Фр╕Юр╕ер╕▓р╕Фр╣Гр╕Щр╕Бр╕▓р╕гр╕Ър╕▒р╕Щр╕Чр╕╢р╕Бр╕кр╕Цр╕▓р╕Щр╕░р╕ер╕Зр╕Рр╕▓р╕Щр╕Вр╣Йр╕нр╕бр╕╣р╕е DB write failure р╕кр╣Ир╕Зр╕Ьр╕ер╣Гр╕лр╣Йр╕кр╕Цр╕▓р╕Щр╕░р╣Др╕бр╣Ир╣Ар╕Ыр╕ер╕╡р╣Ир╕вр╕Щ
  - р╕ер╣Йр╕бр╣Ар╕лр╕ер╕з: idempotency key р╕Лр╣Йр╕│р╣Бр╕Хр╣И payload р╣Бр╕Хр╕Бр╕Хр╣Ир╕▓р╕Зр╕Бр╕▒р╕Щ р╕Чр╕│р╣Гр╕лр╣Йр╣Др╕бр╣Ир╕Фр╕│р╣Ар╕Щр╕┤р╕Щр╕Бр╕▓р╕гр╕Лр╣Йр╕│р╣Бр╕ер╕░р╕Ър╕▒р╕Щр╕Чр╕╢р╕Бр╣Ар╕лр╕Хр╕╕р╕Ьр╕е duplication
  - р╕ер╣Йр╕бр╣Ар╕лр╕ер╕з: webhook р╕кр╣Ир╕Зр╕Вр╣Йр╕нр╕бр╕╣р╕ер╣Др╕бр╣Ир╕Др╕гр╕Ър╕Цр╣Йр╕зр╕Щр╕лр╕гр╕╖р╕н event_type р╣Др╕бр╣Ир╕гр╕нр╕Зр╕гр╕▒р╕Ъ р╕Чр╕│р╣Гр╕лр╣Йр╣Др╕бр╣Ир╕кр╕▓р╕бр╕▓р╕гр╕Цр╕нр╕▒р╕Ыр╣Ар╕Фр╕Хр╕кр╕Цр╕▓р╕Щр╕░р╣Др╕Фр╣Й
  - р╕ер╣Йр╕бр╣Ар╕лр╕ер╕з: р╕Др╕зр╕▓р╕бр╕Ьр╕┤р╕Фр╕Юр╕ер╕▓р╕Фр╕гр╕░р╕лр╕зр╣Ир╕▓р╕Зр╕нр╕▒р╕Ыр╣Ар╕Фр╕Хр╕кр╕Цр╕▓р╕Щр╕░ payment р╕лр╕гр╕╖р╕н booking р╣Ар╕Щр╕╖р╣Ир╕нр╕Зр╕Ир╕▓р╕Бр╕Вр╣Йр╕нр╕Ир╕│р╕Бр╕▒р╕Фр╕Чр╕гр╕▒р╕Юр╕вр╕▓р╕Бр╕г
- ЁЯФД р╕Ьр╕ер╕ер╕▒р╕Юр╕Шр╣Мр╕Чр╕▓р╕Зр╣Ар╕ер╕╖р╕нр╕Б:
  - р╣Др╕бр╣Ир╕бр╕╡
- тЪая╕П р╕Ьр╕ер╕ер╕▒р╕Юр╕Шр╣Мр╕Вр╕нр╕Ър╣Ар╕Вр╕Хр╕Юр╕┤р╣Ар╕ир╕й:
  - р╣Др╕бр╣Ир╕бр╕╡

- тЬЕ р╣Ар╕Бр╕Ур╕Ср╣Мр╕Бр╕▓р╕гр╕вр╕нр╕бр╕гр╕▒р╕Ъ (Acceptance Criteria)
  - Include idempotency keys
  - verify webhook signature
  - repeated webhooks ignored
  - webhook handler <5s processing
  - retry policies

- тП▒ р╕ер╕│р╕Фр╕▒р╕Ър╕Др╕зр╕▓р╕бр╕кр╕│р╕Др╕▒р╕Н / SLA
  - Priority: P0
  - SLA: Webhook process <5s; retry up to 5

---

## ЁЯФБ Sequence Diagram  
> р╣Бр╕кр╕Фр╕Зр╕ер╕│р╕Фр╕▒р╕Ър╣Ар╕лр╕Хр╕╕р╕Бр╕▓р╕гр╕Ур╣Мр╕гр╕░р╕лр╕зр╣Ир╕▓р╕З "р╕Ьр╕╣р╣Йр╣Гр╕Кр╣Й" р╕Бр╕▒р╕Ъ "р╕гр╕░р╕Ър╕Ъ"

```mermaid
sequenceDiagram
  autonumber
  participant U as ЁЯзС р╕Ьр╕╣р╣Йр╣Гр╕Кр╣Й
  participant S as ЁЯТ╗ р╕гр╕░р╕Ър╕Ъ
  U->>S: webhook received from Xendit
  S-->>U: status updated and acknowledgement
```

---

## ЁЯзн Flowchart Diagram
> р╣Бр╕кр╕Фр╕Зр╕Вр╕▒р╣Йр╕Щр╕Хр╕нр╕Щр╕Бр╕▓р╕гр╕Чр╕│р╕Зр╕▓р╕Щр╕Вр╕нр╕Зр╕гр╕░р╕Ър╕Ър╕нр╕вр╣Ир╕▓р╕Зр╣Ар╕Вр╣Йр╕▓р╣Гр╕Ир╕Зр╣Ир╕▓р╕в

```mermaid
flowchart TD
  A[р╣Ар╕гр╕┤р╣Ир╕бр╕Хр╣Йр╕Щ] --> B[р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╣Ар╕Зр╕╖р╣Ир╕нр╕Щр╣Др╕Вр╕Бр╣Ир╕нр╕Щр╣Ар╕гр╕┤р╣Ир╕б]
  B --> C[р╕кр╣Ир╕Зр╕Др╕│р╕Вр╕нр╕Кр╕│р╕гр╕░р╣Ар╕Зр╕┤р╕Щр╣Др╕Ы Xendit]
  C --> D[р╕гр╕н webhook]
  D --> E[р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ъ signature р╣Бр╕ер╕░ idempotency]
  E --> F[р╕нр╕▒р╕Ыр╣Ар╕Фр╕Х payment р╣Бр╕ер╕░ booking]
  F --> G[р╕кр╕┤р╣Йр╕Щр╕кр╕╕р╕Ф]
  E --> H[р╕ер╣Йр╕бр╣Ар╕лр╕ер╕з: signature mismatch р╕лр╕гр╕╖р╕н db write failure р╕лр╕гр╕╖р╕н duplication р╕лр╕гр╕╖р╕н incomplete webhook р╕лр╕гр╕╖р╕н resource constraints]
  H --> G
```

