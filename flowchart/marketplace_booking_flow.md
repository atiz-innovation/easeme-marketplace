# Flow การ hold/lock คูปองและการจองเข้ารับบริการใน Marketplace

ไฟล์นี้อธิบาย Flow การจองคูปอง/บริการใน Marketplace ทั้งกรณี hold/lock ตอนเริ่ม checkout และกรณี hold/lock ทันทีหลังหยิบใส่ตะกร้า พร้อม Mermaid flowchart และคำอธิบายเหตุผล

---

## เหตุผลในการเลือกจุด hold/lock

- **Hold/lock ตอนเริ่ม checkout:**  
  ลดปัญหา slot/coupon ค้างในตะกร้าโดยไม่ถูกซื้อจริง เพิ่มโอกาสให้ลูกค้าคนอื่นจองได้ และป้องกัน overbooking/oversell ได้ดี
- **Hold/lock หลังหยิบใส่ตะกร้า:**  
  ผู้ใช้มั่นใจว่าสินค้าหรือบริการที่เลือกจะยังคงอยู่ในตะกร้าของตนเองในช่วงเวลาหนึ่ง (เช่น 5-10 นาที) โดยไม่ถูกผู้อื่นแย่งจองระหว่างที่กำลังตัดสินใจหรือกรอกข้อมูล  
  ข้อเสียคืออาจทำให้ slot/coupon ถูก hold ค้างในระบบ หากผู้ใช้ไม่ดำเนินการต่อ

---

## 1. Flow หลัก (Hold/lock ตอนเริ่ม checkout)

```mermaid
flowchart TD
    A[เข้าสู่ระบบ Marketplace] --> B[เลือกบริการหรือคูปอง]
    B --> C[ใส่บริการหรือคูปองลงในตะกร้า]
    C --> D{ดำเนินการต่อหรือไม่?}
    D -- ไม่ดำเนินการต่อ --> Z1[คูปอง/slot ยังไม่ถูก hold, ผู้อื่นจองได้]
    D -- ดำเนินการต่อ --> E[ตรวจสอบ/แก้ไขรายการในตะกร้า]
    E --> F{กดสั่งซื้อ/เริ่มจอง?}
    F -- ไม่กด --> Z2[คูปอง/slot ยังไม่ถูก hold, ผู้อื่นจองได้]
    F -- กด --> G[ระบบ hold/lock slot หรือคูปองชั่วคราว]
    G --> H[กรอกข้อมูลที่จำเป็น]
    H --> I[ดำเนินการชำระเงิน]
    I --> J{ชำระเงินสำเร็จภายในเวลาที่กำหนด?}
    J -- ไม่สำเร็จ/หมดเวลา --> K[ปล่อย slot หรือคูปองกลับเข้าสู่ระบบ]
    J -- สำเร็จ --> L[ยืนยันการจองหรือออกคูปอง]
    K --> Z3[ผู้อื่นสามารถจอง slot/coupon ได้]
    L --> M[แจ้งเตือนผู้ใช้]
    M --> N[นำคูปองหรือข้อมูลการจองไปใช้บริการ]
    N --> O{ต้องการยกเลิก/เปลี่ยนแปลง?}
    O -- ใช่ --> P{นโยบาย Marketplace อนุญาต?}
    P -- อนุญาต --> Q[ดำเนินการคืนเงิน/เปลี่ยนแปลง]
    P -- ไม่อนุญาต --> R[ไม่สามารถคืนเงิน/เปลี่ยนแปลงได้]
    O -- ไม่ต้องการ --> S[รอใช้บริการตามวัน-เวลา]
    S --> T{ไม่มาใช้บริการ?}
    T -- ใช่ --> U[อาจถูก Blacklist/Penalty]
    T -- ไม่ใช่ --> V[จบกระบวนการ]
    %% กรณีระบบล่ม/แจ้งเตือนล่าช้า
    L --> W{ระบบแจ้งเตือนล่าช้าหรือขัดข้อง?}
    W -- ใช่ --> X[ผู้ใช้สับสน, ต้องติดต่อ support]
    W -- ไม่ใช่ --> V
    %% กรณี oversell/concurrency
    G --> Y{มีผู้ใช้หลายคน hold พร้อมกัน?}
    Y -- ใช่ --> Z[ระบบต้องจัดการ concurrency ป้องกัน oversell/double booking]
    Y -- ไม่ใช่ --> H
    %% กรณีจองซ้ำซ้อน/จองเกิน
    Z --> AA{เกิด double booking หรือ overbooking?}
    AA -- ใช่ --> AB[แจ้งเตือน/แก้ไข/ย้ายคิว/คืนเงิน]
    AA -- ไม่ใช่ --> H
    %% กรณีแจ้งเตือน slot/coupon ใกล้หมด
    B --> AC{slot/coupon ใกล้หมด?}
    AC -- ใช่ --> AD[แจ้งเตือนผู้ใช้]
    AC -- ไม่ใช่ --> C
    %% กรณีชำระเงินล้มเหลว
    I --> AE{ระบบชำระเงินล้มเหลว?}
    AE -- ใช่ --> AF[แจ้งเตือนผู้ใช้, ให้ลองใหม่]
    AE -- ไม่ใช่ --> J
```

---

## 2. Flow กรณี hold/lock หลังหยิบใส่ตะกร้า

```mermaid
flowchart TD
    A[เข้าสู่ระบบ Marketplace] --> B[เลือกบริการหรือคูปอง]
    B --> C[ใส่บริการหรือคูปองลงในตะกร้า]
    C --> D[ระบบ hold/lock slot หรือคูปองชั่วคราว]
    D --> E{ดำเนินการต่อหรือไม่?}
    E -- ไม่ดำเนินการต่อ/หมดเวลา hold --> F[ปล่อย slot หรือคูปองกลับเข้าสู่ระบบ]
    E -- ดำเนินการต่อ --> G[ตรวจสอบ/แก้ไขรายการในตะกร้า]
    G --> H{กดสั่งซื้อ/เริ่มจอง?}
    H -- ไม่กด --> F
    H -- กด --> I[กรอกข้อมูลที่จำเป็น]
    I --> J[ดำเนินการชำระเงิน]
    J --> K{ชำระเงินสำเร็จภายในเวลาที่กำหนด?}
    K -- ไม่สำเร็จ/หมดเวลา hold --> F
    K -- สำเร็จ --> L[ยืนยันการจองหรือออกคูปอง]
    L --> M[แจ้งเตือนผู้ใช้]
    M --> N[นำคูปองหรือข้อมูลการจองไปใช้บริการ]
    N --> O{ต้องการยกเลิก/เปลี่ยนแปลง?}
    O -- ใช่ --> P{นโยบาย Marketplace อนุญาต?}
    P -- อนุญาต --> Q[ดำเนินการคืนเงิน/เปลี่ยนแปลง]
    P -- ไม่อนุญาต --> R[ไม่สามารถคืนเงิน/เปลี่ยนแปลงได้]
    O -- ไม่ต้องการ --> S[รอใช้บริการตามวัน-เวลา]
    S --> T{ไม่มาใช้บริการ?}
    T -- ใช่ --> U[อาจถูก Blacklist/Penalty]
    T -- ไม่ใช่ --> V[จบกระบวนการ]
    %% กรณีระบบล่ม/แจ้งเตือนล่าช้า
    L --> W{ระบบแจ้งเตือนล่าช้าหรือขัดข้อง?}
    W -- ใช่ --> X[ผู้ใช้สับสน, ต้องติดต่อ support]
    W -- ไม่ใช่ --> V
    %% กรณี oversell/concurrency
    G --> Y{มีผู้ใช้หลายคน hold พร้อมกัน?}
    Y -- ใช่ --> Z[ระบบต้องจัดการ concurrency ป้องกัน oversell/double booking]
    Y -- ไม่ใช่ --> H
    %% กรณีจองซ้ำซ้อน/จองเกิน
    Z --> AA{เกิด double booking หรือ overbooking?}
    AA -- ใช่ --> AB[แจ้งเตือน/แก้ไข/ย้ายคิว/คืนเงิน]
    AA -- ไม่ใช่ --> H
    %% กรณีแจ้งเตือน slot/coupon ใกล้หมด
    B --> AC{slot/coupon ใกล้หมด?}
    AC -- ใช่ --> AD[แจ้งเตือนผู้ใช้]
    AC -- ไม่ใช่ --> C
    %% กรณีชำระเงินล้มเหลว
    I --> AE{ระบบชำระเงินล้มเหลว?}
    AE -- ใช่ --> AF[แจ้งเตือนผู้ใช้, ให้ลองใหม่]
    AE -- ไม่ใช่ --> J
```
